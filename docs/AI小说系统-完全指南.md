# NovelFlow 叙谱 - AI小说创作系统完全指南

## 1. 项目概览

**NovelFlow 叙谱** 是一个商业化 AI 小说创作平台，采用单一 Go 服务架构，通过智能 AI 技术帮助作者从创意到成稿完成小说创作。

### 核心特性
- **🌍 世界构建器**：基于 7 阶段演化系统，自动推导哲学→世界观→法则→地理→文明→历史的依赖链。
- **📖 叙事引擎**：整合成熟叙事理论（三幕结构、英雄之旅、救猫咪等），规划情节结构与冲突弧光。
- **✍️ 智能写作**：场景化文本生成，实时维护角色与世界状态的一致性。
- **🎼 多种创作模式**：支持规划生成、干预生成、随机生成、故事核、短篇及剧本模式。
- **⚙️ 异步调度**：支持多项目并发的任务调度系统。

---

## 2. 快速开始

### 环境要求
- **Go**: 1.23+
- **PostgreSQL**: 14+
- **智谱AI API Key**: [https://open.bigmodel.cn/](https://open.bigmodel.cn/)

### 启动服务

1. **配置环境变量** (`.env`)
   ```env
   DB_HOST=localhost
   DB_PORT=5432
   DB_USER=postgres
   DB_PASSWORD=your_password
   DB_NAME=novelflow
   ZHIPU_API_KEY=your_zhipu_api_key
   JWT_SECRET=your-secret-key
   ```

2. **编译并启动**
   ```bash
   go mod download
   go build -o bin/api cmd/api/main.go
   ./bin/api
   ```
   服务将运行在 `http://localhost:8080`。

---

## 3. 系统架构

系统采用分层协作架构：

```
┌─────────────────────────────────────────────────────────────┐
│                  Frontend (React SPA)                       │
└────────────────────────────┬────────────────────────────────┘
                             │ REST API
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                       Backend (Go)                          │
├─────────────┬──────────────┬──────────────┬─────────────────┤
│   调度器    │   编排器     │  API Handler │   Middleware    │
│ (Scheduler) │(Orchestrator)│              │                 │
├─────────────┴──────────────┴──────────────┴─────────────────┤
│                        核心业务层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ World Builder│  │  Narrative   │  │    Writer    │   │
│  │  世界构建器  │  │   Engine     │  │   写作器     │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│         │                 │                 │           │
│         └─────────────────┴─────────────────┘           │
│                          ↓                              │
│                ┌─────────────────────┐                  │
│                │   知识数据服务      │                  │
│                └─────────────────────┘                  │
└────────────────────────────┬────────────────────────────────┘
                             ↓
                  ┌─────────────────────┐
                  │    PostgreSQL DB    │
                  └─────────────────────┘
```

### 核心模块职责
1.  **调度器 (Scheduler)**：系统入口，管理多项目并发与资源分配。
2.  **编排器 (Orchestrator)**：单部小说的指挥中心，协调世界、叙事、写作三大引擎。
3.  **世界构建器 (World Builder)**：负责“从无到有”创造世界。
4.  **叙事引擎 (Narrative Engine)**：负责“写什么”，规划大纲与章节。
5.  **写作器 (Writer)**：负责“怎么写”，生成具体文本。
6.  **知识服务 (Knowledge Service)**：提供写作规则与通用知识。

---

## 4. 核心功能实现

### 4.1 世界构建器 (7阶段演化系统)
实现文件：`pkg/worldbuilder/*`

构建过程通过约 200+ 轮 LLM 调用，严格遵循依赖链生成：

| 阶段 | 核心任务 | 输入 | 输出 |
| :--- | :--- | :--- | :--- |
| **1. 哲学思考** | 确立核心问题与价值体系 | 类型、主题 | 哲学基础、价值观 |
| **2. 世界观** | 推导宇宙论与形而上学 | 哲学基础 | 世界起源、法则雏形 |
| **3. 法则设定** | 物理/魔法/超自然体系 | 世界观 | 能量规则、代价机制 |
| **4. 地理环境** | 生成地形、气候、资源 | 法则 | 区域地图、资源分布 |
| **5. 文明社会** | 种族、语言、宗教、政体 | 地理 | 文明档案、社会结构 |
| **6. 历史演化** | 生成编年史与文化遗产 | 文明 | 历史事件、集体记忆 |
| **7. 一致性检查**| 逻辑自洽验证 | 所有设定 | 修正建议、一致性报告 |

**关键实现**：
- **链式演化**：下一阶段 Prompt 自动包含上一阶段的 JSON 输出。
- **故事土壤**：专门生成的 `StorySoil` 数据结构（包含社会矛盾、潜在冲突），直接供给叙事引擎使用。

### 4.2 叙事引擎 (Narrative Engine)
实现文件：`pkg/narrative/*`

负责将世界设定转化为可执行的写作蓝图。

1.  **世界摘要提取**：通过 `buildWorldSummary()` 从庞大的世界设定中提炼出对叙事有用的信息（如核心矛盾、地理场景）。
2.  **多轮规划**：
    *   **大纲生成**：基于三幕结构/英雄之旅生成整体故事脉络。
    *   **章节拆分**：将大纲拆解为具体章节，确定每章的“动作”与“钩子”。
    *   **场景指令**：为每章生成详细的场景序列（Location, Characters, Action, Dialogue Focus）。
3.  **角色弧光**：规划主角的心理变化轨迹（起始状态 -> 转折点 -> 终止状态）。

### 4.3 写作器 (Writer)
实现文件：`pkg/writer/*`

负责执行场景指令，生成最终文本。

1.  **上下文装载**：加载当前场景的地点信息、在场角色状态、前情提要。
2.  **文本生成**：调用 LLM 生成对话与描写，支持流式输出。
3.  **状态更新**：根据生成内容反向更新角色状态（如心情变化、位置移动、获得物品）。

### 4.4 模块联动数据流

```
WorldSetting (DB)
    │
    ▼
NarrativeEngine (提取摘要) ──LLM──> NarrativeBlueprint (DB)
                                          │
                                          ▼
                                     Writer (执行指令)
                                          │
    ┌─────────────────────────────────────┴──────────────────┐
    ▼                                                        ▼
NovelText (文本)                                       StateUpdates (状态)
```

---

## 5. 后端服务与 API

### 5.1 认证系统
实现文件：`internal/services/auth/*`

*   **模型**：基于 JWT 的双 Token 机制（Access Token 24h, Refresh Token 30d）。
*   **安全**：密码使用 bcrypt 哈希，Token 包含用户 ID 与等级 (Tier) 信息。
*   **功能**：注册、登录、刷新 Token、密码重置（邮件流）、修改密码。

### 5.2 作品管理与工作台 API
实现文件：`internal/handlers/project.go`, `internal/handlers/chapter.go`

*   **作品管理**：CRUD、封面上传、状态流转。
*   **章节管理**：
    *   `POST /generate/continue`：AI 续写（流式响应）。
    *   `POST /generate/expand`：AI 扩写。
    *   `POST /generate/polish`：AI 润色。
*   **数据结构**：所有作品数据均存储在 PostgreSQL，JSONB 字段用于存储复杂的设定数据。

---

## 6. 前端实现 (React API)

前端位于 `static/` 或独立仓库，采用 React + TypeScript + Zustand。

### 核心页面
1.  **作品列表**：卡片式展示，支持状态筛选。
2.  **创作工作台 (Workbench)**：
    *   **左侧**：大纲与章节导航。
    *   **中间**：沉浸式富文本编辑器 (Tiptap)，支持 AI 辅助快捷指令。
    *   **右侧**：资料面板（世界设定、角色卡片），支持从编辑器选中文字直接查询。

### 关键组件
*   **ProjectStore**：管理当前加载的项目状态。
*   **NovelEditor**：封装 Tiptap，集成 AI 续写/润色浮窗。
*   **AIToolPanel**：右侧 AI 工具栏，提供上下文感知的写作辅助。

---

## 7. 数据库设计

### 主要表结构
*   **users**: 用户基础信息、等级。
*   **projects**: 项目元数据，关联 `world_id` 和 `narrative_id`。
*   **world_settings**: 存储 7 阶段生成的完整 JSON 数据（JSONB）。
*   **narrative_blueprints**: 存储大纲、章节规划、场景指令（JSONB）。
*   **chapters**: 实际的小说章节文本。
*   **characters**: 角色档案及其动态状态。

---

## 8. 开发路线与维护

### 已完成
- [x] 7阶段世界构建核心算法
- [x] 叙事引擎基础框架
- [x] 写作器与状态更新
- [x] 完整认证系统
- [x] 基础 API 服务

### 待办事项
- [ ] 前端工作台深度集成（目前为基础版）
- [ ] 异步任务调度的持久化与恢复
- [ ] 支付与订阅系统对接
- [ ] 移动端适配
