# NovelFlow 叙谱 - AI小说创作系统架构概览

## 系统定位

一个分层协作的AI小说创作系统，通过六个模块协同工作，完成从创意到成稿的全流程。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         调度器                             │
│                      (Scheduler)                           │
│                    系统入口 | 并发管理                      │
└────────────────────────┬────────────────────────────────────┘
                         │ 创建/管理
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                        编排器                              │
│                      (Orchestrator)                         │
│              一部小说 = 一个编排器实例                      │
│                                                               │
│  六种编排模式：                                              │
│  • 规划生成  • 干预生成  • 随机生成  • 故事核              │
│  • 短篇模式  • 剧本模式                                    │
└────────────────────────┬────────────────────────────────────┘
                         │ 协调
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                      三大核心层                             │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   世界设定器    │  │     叙事器      │  │    写作器   │ │
│  │  World Builder  │  │  Narrative Eng  │  │   Writer    │ │
│  │                 │  │                 │  │             │ │
│  │ 构建世界设定     │  │ 规划情节结构    │  │ 生成具体文本 │ │
│  │ 生成故事土壤     │  │ 设计冲突弧光    │  │ 维护状态一致│ │
│  └────────┬────────┘  └────────┬────────┘  └──────┬──────┘ │
│           │                    │                   │         │
│           └────────────────────┴───────────────────┘         │
│                            │                                │
│                            ↓                                │
│                 ┌─────────────────────┐                    │
│                 │   知识数据服务      │                    │
│                 │  Knowledge Service │                    │
│                 │                     │                    │
│                 │ • 写作规则库       │                    │
│                 │ • 知识素材库       │                    │
│                 │ • 自我扩充         │                    │
│                 └─────────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块功能

### 1. 调度器 (Scheduler)

**职责：** 系统入口，负责创建和管理编排器实例

**功能：**
- 创建编排器（每部小说一个独立实例）
- 并发管理多个编排器
- 资源分配与调度
- 监控执行状态

**输入：** 用户请求（创作模式、参数）
**输出：** 编排器实例

---

### 2. 编排器 (Orchestrator)

**职责：** 单部小说的编排中心，协调三大核心层完成创作

**编排模式：**

| 模式 | 说明 | 流程 |
|------|------|------|
| 规划生成 | 搜集参数 → 世界设定 → 叙事规划 → 写作生成 |
| 干预生成 | 用户在任意节点干预，调整后继续 |
| 随机生成 | 基于参数随机生成创意 |
| 故事核 | 从一句话创意扩写 |
| 短篇模式 | 一次性生成短篇小说 |
| 剧本模式 | 按剧本格式输出 |

**协调流程：**
```
用户参数 → 世界设定器 → 世界设定集
                         ↓
              叙事器（接收设定集）→ 叙事蓝图
                         ↓
              写作器（接收蓝图+设定）→ 具体文本
                         ↓
              知识数据服务（提供规则/知识）
```

---

### 3. 世界设定器 (World Builder)

**职责：** 构建有机、自洽、能产生故事的世界系统

**生成流程（分阶段LLM调用）：**

```
第1阶段：哲学思考
    ↓ 依赖
第2阶段：世界观（从哲学推导）
    ↓ 依赖
第3阶段：法则设定（物理/魔法体系）
    ↓ 依赖
第4阶段：地理环境
    ↓ 依赖
第5阶段：文明社会
    ↓ 依赖
第6阶段：历史演化
    ↓ 依赖
第7阶段：一致性检查
```

**输出：** 世界设定包 → 传递给叙事器

```json
{
  "world_package": {
    "story_soil": "社会矛盾/权力结构/历史遗产",  // 叙事器用
    "setting_constraints": "设定约束",              // 写作器用
    "character_base": "角色基础设定"                // 角色数据库
  }
}
```

---

### 4. 叙事器 (Narrative Engine)

**职责：** 规划"写什么"——情节、冲突、弧光

**输入：** 世界设定包 + 创作意图

**演化流程（多轮LLM调用）：**

```
轮次1：生成整体大纲（使用三幕/英雄之旅等理论）
    ↓
轮次2：细化章节规划（逐章分解）
    ↓
轮次3：生成场景序列（每章场景列表）
    ↓
轮次4：动态演化（根据前文调整后续）
```

**输出：** 叙事蓝图 → 传递给写作器

```json
{
  "narrative_blueprint": {
    "story_outline": "整体大纲",
    "chapter_plans": "章节规划",
    "scene_instructions": "场景指令序列",
    "character_arcs": "角色弧光规划",
    "theme_plan": "主题贯穿计划"
  }
}
```

**角色分工：**
- 接收：世界设定器的角色基础设定
- 生成：角色性格、动机、弧光规划
- 输出：角色弧光规划 → 写作器

---

### 5. 写作器 (Writer)

**职责：** 生成"怎么写"——具体文本内容

**输入：** 叙事蓝图 + 世界设定包

**处理流程：**

```
解析场景指令
    ↓
查询角色状态、关系状态、环境状态
    ↓
生成内容（对话/动作/描写）
    ↓
应用视角过滤
    ↓
应用风格控制
    ↓
输出文本 + 状态更新
```

**核心组件：**
- 角色系统：维护角色动态状态
- 对话生成器：生成符合角色的对话
- 场景渲染器：环境描写与氛围
- 视角处理器：信息控制与过滤
- 情感引擎：情绪变化计算

**输出：** 场景文本 + 状态更新（回写数据库）

**角色分工：**
- 接收：世界设定器的角色基础设定
- 接收：叙事器的角色弧光规划
- 维护：角色动态状态（实时更新）

---

### 6. 知识数据服务 (Knowledge Service)

**职责：** 为写作器提供写作规则和知识素材

**功能：**
- 写作规则库（文体规范、技巧指南）
- 知识素材库（历史、科学、文艺等）
- 自我扩充：查询缺失知识并自动添加

**交互：** 写作器按需调用

---

## 模块交互图

```
┌──────────────┐
│    用户      │
└──────┬───────┘
       │ 请求
       ↓
┌─────────────────────────────────────────────────────────┐
│  调度器: 创建编排器实例                                  │
└──────┬──────────────────────────────────────────────────┘
       │
       ↓
┌─────────────────────────────────────────────────────────┐
│  编排器: 协调创作流程                                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 第1步: 调用世界设定器                             │   │
│  │   输入: 用户参数                                  │   │
│  │   输出: 世界设定包                                │   │
│  │           ↓                                       │   │
│  │ 第2步: 调用叙事器                                 │   │
│  │   输入: 世界设定包 + 创作意图                     │   │
│  │   输出: 叙事蓝图                                  │   │
│  │           ↓                                       │   │
│  │ 第3步: 调用写作器（循环每场景）                   │   │
│  │   输入: 叙事蓝图 + 世界设定包 + 知识服务          │   │
│  │   输出: 场景文本 + 状态更新                        │   │
│  │           ↓                                       │   │
│  │ 第4步: 汇总成稿                                    │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
       │
       ↓ 输出
┌──────────────┐
│   小说文本   │
└──────────────┘
```

## 数据流转

```
┌─────────────────────────────────────────────────────────┐
│                    数据流向                              │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  世界设定器 ────→ 世界设定包 ────→ 叙事器               │
│                                            ↓              │
│  知识服务 ─────────────────────→ 写作器 ←────┘          │
│                                            ↓              │
│  角色数据库 ←──────────────────── 状态更新               │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

## 数据库设计

**角色数据库：**
```json
{
  "character_id": {
    "static_profile": {},      // 世界设定器生成
    "narrative_profile": {},   // 叙事器生成
    "dynamic_state": {}        // 写作器维护
  }
}
```

**世界数据库：**
```json
{
  "world_id": {
    "philosophy": {},          // 哲学思考
    "worldview": {},           // 世界观
    "settings": {},           // 设定
    "story_soil": {}          // 故事土壤
  }
}
```

## 技术要点

1. **分阶段LLM调用**：世界设定和叙事演化都不是一次完成，而是多轮迭代
2. **结构化输出**：所有LLM输出统一为JSON格式，便于程序处理
3. **依赖链保存**：用`derivation`字段记录生成逻辑
4. **状态持久化**：角色状态、世界状态实时保存
5. **一致性检查**：每阶段生成后进行逻辑自洽验证

## 文档说明

- **本文档**：架构概览，快速了解系统功能
- **完整文档**：`AI小说系统-完整实现文档.md`，包含详细规则和实现
